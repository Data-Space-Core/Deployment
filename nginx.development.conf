worker_processes  auto;
user              nginx;
error_log         /var/log/nginx/error.log notice;
pid               /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout 65;

    # Docker DNS
    resolver 127.0.0.11 valid=30s;

    # upstream definitions
    upstream provide_ui        { server provide-user-interface:8000; }
    upstream connector_backend { server connector:8081; }
    upstream broker_core       { server broker-core:8080; }
    upstream broker_fuseki     { server broker-fuseki:3030; }
    upstream auth_backend      { server daps:4567; }
    upstream ui_backend        { server omejdn-ui:80; }

    # Redirect all HTTP â†’ HTTPS
    server {
        listen      80;
        server_name __HOST__;
        return      301 https://$host$request_uri;
    }

    server {
        listen       443 ssl http2;
        server_name  __HOST__;

        ssl_certificate     /etc/cert/__CERT__;
        ssl_certificate_key /etc/cert/__KEY__;
        ssl_protocols       TLSv1.2 TLSv1.3;
        ssl_ciphers         HIGH:!aNULL:!MD5;

        # 1) Your Django UI under /provide/
        location /provide/ {
            proxy_pass         http://provide_ui/;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_redirect     off;
        }

        # 2) The connector API under /connector/
        location /connector/ {
            proxy_pass         https://connector_backend/;
            proxy_ssl_verify   off;
            add_header         Access-Control-Allow-Origin  *;
            add_header         Access-Control-Allow-Methods 'GET, POST, OPTIONS';
            add_header         Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_redirect     off;
        }

        # 3) Broker Core: connectors
        location /broker/connectors/ {
            rewrite            ^/broker/connectors/(.*)$ /connectors/$1 break;
            proxy_pass         http://broker_core/connectors/;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_redirect     off;
        }

        # 4) Broker Core: catalog
        location /broker/catalog/ {
            rewrite            ^/broker/catalog/(.*)$ /catalog/$1 break;
            proxy_pass         http://broker_core/catalog/;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_redirect     off;
        }

        # 5) Fuseki SPARQL
        location /broker/fuseki/ {
            rewrite            ^/broker/fuseki/(.*)$ /$1 break;
            proxy_pass         http://broker_fuseki/;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_redirect     off;
        }

        # 6) Broker infrastructure
        location /broker/infrastructure/ {
            rewrite            ^/broker/infrastructure/(.*)$ /infrastructure/$1 break;
            proxy_pass         http://broker_core/infrastructure/;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_redirect     off;
        }

        # 7) DAPS / OpenID under /auth/
        location /auth/ {
            rewrite            ^/auth/(.*)$ /$1 break;
            proxy_pass         http://auth_backend/;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_redirect     off;
        }

        # 8) well-known mappings
        location /.well-known/ {
            rewrite ^/\.well-known/oauth-authorization-server/auth /auth/.well-known/oauth-authorization-server last;
            rewrite ^/\.well-known/openid-configuration/auth       /auth/.well-known/openid-configuration       last;
            rewrite ^/\.well-known/webfinger                        /auth/.well-known/webfinger                      last;
            rewrite ^/\.well-known/jwks.json                        /auth/jwks.json                                  last;
            proxy_pass         http://auth_backend/;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_redirect     off;
        }

        # 9) Admin UI & catch-all
        location / {
            proxy_pass         http://ui_backend/;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_redirect     off;
        }
    }
}
